<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTTech Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        body { font-family: 'Inter', system-ui, sans-serif; }
        
        .card { 
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-primary { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
        .gradient-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .gradient-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .gradient-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }
        
        .stat-card.primary::before { background: var(--primary); }
        .stat-card.success::before { background: var(--success); }
        .stat-card.warning::before { background: var(--warning); }
        .stat-card.danger::before { background: var(--danger); }
        
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .sidebar {
            background: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%);
        }
        
        .nav-item {
            transition: all 0.2s;
            border-radius: 8px;
            margin: 2px 8px;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
        }
        
        .table-row:hover {
            background: #f8fafc;
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="sidebar w-64 fixed h-full text-white hidden lg:block">
            <div class="p-6">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-indigo-400 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-pie text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg">VTTech</h1>
                        <p class="text-xs text-indigo-300">Analytics Dashboard</p>
                    </div>
                </div>
            </div>
            
            <nav class="mt-6">
                <a href="#" class="nav-item active flex items-center px-4 py-3 text-white">
                    <i class="fas fa-home w-6"></i>
                    <span>Tổng quan</span>
                </a>
                <a href="customers.html" class="nav-item flex items-center px-4 py-3 text-indigo-200 hover:text-white">
                    <i class="fas fa-user-group w-6"></i>
                    <span>Khách hàng</span>
                </a>
                <a href="#revenue" class="nav-item flex items-center px-4 py-3 text-indigo-200 hover:text-white">
                    <i class="fas fa-chart-line w-6"></i>
                    <span>Doanh thu</span>
                </a>
                <a href="#branches" class="nav-item flex items-center px-4 py-3 text-indigo-200 hover:text-white">
                    <i class="fas fa-store w-6"></i>
                    <span>Chi nhánh</span>
                </a>
                <a href="#services" class="nav-item flex items-center px-4 py-3 text-indigo-200 hover:text-white">
                    <i class="fas fa-spa w-6"></i>
                    <span>Dịch vụ</span>
                </a>
                <a href="#employees" class="nav-item flex items-center px-4 py-3 text-indigo-200 hover:text-white">
                    <i class="fas fa-users w-6"></i>
                    <span>Nhân viên</span>
                </a>
                <a href="callcenter.html" class="nav-item flex items-center px-4 py-3 text-indigo-200 hover:text-white">
                    <i class="fas fa-headset w-6"></i>
                    <span>Call Center</span>
                </a>
                <a href="sync-status.html" class="nav-item flex items-center px-4 py-3 text-indigo-200 hover:text-white">
                    <i class="fas fa-sync w-6"></i>
                    <span>Sync Status</span>
                </a>
                <a href="db.html" class="nav-item flex items-center px-4 py-3 text-indigo-200 hover:text-white">
                    <i class="fas fa-database w-6"></i>
                    <span>Database</span>
                </a>
            </nav>
            
            <div class="absolute bottom-0 left-0 right-0 p-4">
                <div class="bg-indigo-800/50 rounded-lg p-4">
                    <p class="text-xs text-indigo-300">Database</p>
                    <p class="text-sm font-medium">vttech.db</p>
                    <p id="dbStatus" class="text-xs text-green-400 mt-1">
                        <i class="fas fa-circle text-xs mr-1"></i>Connected
                    </p>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="flex-1 lg:ml-64">
            <!-- Top Bar -->
            <header class="bg-white shadow-sm sticky top-0 z-10">
                <div class="flex items-center justify-between px-6 py-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Dashboard</h2>
                        <p id="currentDate" class="text-sm text-gray-500"></p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <select id="dateSelect" class="border rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                            <option value="">Chọn ngày...</option>
                        </select>
                        <button onclick="refreshData()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                            <i class="fas fa-sync-alt mr-2"></i>Làm mới
                        </button>
                    </div>
                </div>
            </header>
            
            <div class="p-6">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card primary shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Doanh thu hôm nay</p>
                                <p id="todayRevenue" class="text-2xl font-bold text-gray-800 mt-1">--</p>
                                <p id="revenueChange" class="text-sm mt-2">
                                    <span class="text-green-500"><i class="fas fa-arrow-up"></i> --%</span>
                                    <span class="text-gray-400 ml-1">vs hôm qua</span>
                                </p>
                            </div>
                            <div class="w-14 h-14 bg-indigo-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-dollar-sign text-2xl text-indigo-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card success shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Tổng tháng 12</p>
                                <p id="monthRevenue" class="text-2xl font-bold text-gray-800 mt-1">--</p>
                                <p class="text-sm mt-2 text-gray-400">
                                    <span id="monthDays">--</span> ngày có dữ liệu
                                </p>
                            </div>
                            <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-calendar-check text-2xl text-green-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card warning shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Chi nhánh</p>
                                <p id="branchCount" class="text-2xl font-bold text-gray-800 mt-1">17</p>
                                <p class="text-sm mt-2 text-gray-400">
                                    Taza, Timona, Hderma
                                </p>
                            </div>
                            <div class="w-14 h-14 bg-yellow-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-store text-2xl text-yellow-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card danger shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Dữ liệu trong DB</p>
                                <p id="totalRecords" class="text-2xl font-bold text-gray-800 mt-1">--</p>
                                <p class="text-sm mt-2 text-gray-400">
                                    <span id="lastSync">--</span>
                                </p>
                            </div>
                            <div class="w-14 h-14 bg-red-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-database text-2xl text-red-600"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Revenue Trend Chart -->
                    <div class="card bg-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-800">Xu hướng doanh thu</h3>
                            <span class="badge bg-indigo-100 text-indigo-700">30 ngày</span>
                        </div>
                        <div class="h-72">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Branch Revenue Chart -->
                    <div class="card bg-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-800">Doanh thu theo chi nhánh</h3>
                            <span id="chartDate" class="badge bg-green-100 text-green-700">--</span>
                        </div>
                        <div class="h-72">
                            <canvas id="branchChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Branch Table -->
                <div class="card bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-bold text-gray-800">Chi tiết theo chi nhánh</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="text-left px-6 py-4 text-xs font-semibold text-gray-500 uppercase">Chi nhánh</th>
                                    <th class="text-right px-6 py-4 text-xs font-semibold text-gray-500 uppercase">Doanh thu</th>
                                    <th class="text-right px-6 py-4 text-xs font-semibold text-gray-500 uppercase">Khách mới</th>
                                    <th class="text-right px-6 py-4 text-xs font-semibold text-gray-500 uppercase">Số KH</th>
                                    <th class="text-right px-6 py-4 text-xs font-semibold text-gray-500 uppercase">Lịch hẹn</th>
                                    <th class="text-center px-6 py-4 text-xs font-semibold text-gray-500 uppercase">%</th>
                                </tr>
                            </thead>
                            <tbody id="branchTableBody">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-gray-400">
                                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                                        <p class="mt-2">Đang tải dữ liệu...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Data Quality Section -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
                    <div class="card bg-white rounded-xl p-6 shadow-lg">
                        <h4 class="font-bold text-gray-800 mb-4">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>Master Data
                        </h4>
                        <div id="masterDataStats" class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Branches</span>
                                <span class="font-semibold">17</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Services</span>
                                <span class="font-semibold">1,728</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Employees</span>
                                <span class="font-semibold">1,620</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Users</span>
                                <span class="font-semibold">1,069</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card bg-white rounded-xl p-6 shadow-lg">
                        <h4 class="font-bold text-gray-800 mb-4">
                            <i class="fas fa-calendar text-blue-500 mr-2"></i>Revenue Data
                        </h4>
                        <div id="revenueDataStats" class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Total Records</span>
                                <span id="revenueRecords" class="font-semibold">425</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Days with Data</span>
                                <span id="daysWithData" class="font-semibold">25</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Latest Date</span>
                                <span id="latestDate" class="font-semibold">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Coverage</span>
                                <span class="font-semibold text-green-600">83%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card bg-white rounded-xl p-6 shadow-lg">
                        <h4 class="font-bold text-gray-800 mb-4">
                            <i class="fas fa-clock text-purple-500 mr-2"></i>Sync Status
                        </h4>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500">Last Sync</span>
                                <span id="lastSyncTime" class="font-semibold">--</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500">Status</span>
                                <span class="badge bg-green-100 text-green-700">Success</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500">Next Sync</span>
                                <span class="font-semibold">06:00 AM</span>
                            </div>
                            <button onclick="runSync()" class="w-full mt-4 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">
                                <i class="fas fa-sync-alt mr-2"></i>Sync Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Config
        const API_BASE = window.location.origin;
        let revenueChart, branchChart;
        
        // Format currency
        function formatCurrency(value) {
            if (value >= 1000000000) {
                return (value / 1000000000).toFixed(2) + ' tỷ';
            } else if (value >= 1000000) {
                return (value / 1000000).toFixed(0) + ' triệu';
            }
            return value.toLocaleString('vi-VN') + ' đ';
        }
        
        // Format number
        function formatNumber(num) {
            return num.toLocaleString('vi-VN');
        }
        
        // Fetch data
        async function fetchData(endpoint) {
            try {
                const resp = await fetch(`${API_BASE}${endpoint}`);
                return await resp.json();
            } catch (error) {
                console.error('Fetch error:', error);
                return null;
            }
        }
        
        // Init charts
        function initCharts() {
            // Revenue trend chart
            const ctx1 = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Doanh thu',
                        data: [],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
            
            // Branch chart
            const ctx2 = document.getElementById('branchChart').getContext('2d');
            branchChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Doanh thu',
                        data: [],
                        backgroundColor: [
                            '#6366f1', '#8b5cf6', '#a855f7', '#d946ef',
                            '#ec4899', '#f43f5e', '#ef4444', '#f97316',
                            '#f59e0b', '#eab308', '#84cc16', '#22c55e',
                            '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Load summary
        async function loadSummary() {
            const data = await fetchData('/api/summary');
            if (!data) return;
            
            // Populate date select
            const select = document.getElementById('dateSelect');
            select.innerHTML = '<option value="">Chọn ngày...</option>';
            (data.available_dates || []).forEach(date => {
                select.innerHTML += `<option value="${date}">${date}</option>`;
            });
            
            if (data.available_dates && data.available_dates.length > 0) {
                select.value = data.available_dates[0];
                document.getElementById('latestDate').textContent = data.available_dates[0];
                loadRevenueByDate(data.available_dates[0]);
            }
            
            // Master counts
            if (data.master_counts) {
                const mc = data.master_counts;
                document.getElementById('branchCount').textContent = mc.branches || 17;
                document.getElementById('totalRecords').textContent = formatNumber(
                    (mc.branches || 0) + (mc.services || 0) + (mc.employees || 0) + (mc.users || 0) + 425
                );
            }
        }
        
        // Load revenue trend
        async function loadRevenueTrend() {
            const data = await fetchData('/api/revenue/range');
            if (!data || !Array.isArray(data)) return;
            
            const labels = data.map(d => d.date.slice(5)); // MM-DD
            const values = data.map(d => d.total || 0);
            
            revenueChart.data.labels = labels;
            revenueChart.data.datasets[0].data = values;
            revenueChart.update();
            
            // Calculate month total
            const monthTotal = values.reduce((a, b) => a + b, 0);
            document.getElementById('monthRevenue').textContent = formatCurrency(monthTotal);
            document.getElementById('monthDays').textContent = data.length;
            document.getElementById('daysWithData').textContent = data.length;
            document.getElementById('revenueRecords').textContent = data.length * 17;
            
            // Today vs yesterday
            if (data.length >= 2) {
                const today = data[data.length - 1]?.total || 0;
                const yesterday = data[data.length - 2]?.total || 0;
                
                document.getElementById('todayRevenue').textContent = formatCurrency(today);
                
                if (yesterday > 0) {
                    const change = ((today - yesterday) / yesterday * 100).toFixed(1);
                    const changeEl = document.getElementById('revenueChange');
                    if (change >= 0) {
                        changeEl.innerHTML = `<span class="text-green-500"><i class="fas fa-arrow-up"></i> ${change}%</span>
                            <span class="text-gray-400 ml-1">vs hôm qua</span>`;
                    } else {
                        changeEl.innerHTML = `<span class="text-red-500"><i class="fas fa-arrow-down"></i> ${Math.abs(change)}%</span>
                            <span class="text-gray-400 ml-1">vs hôm qua</span>`;
                    }
                }
            }
        }
        
        // Load revenue by date
        async function loadRevenueByDate(date) {
            const data = await fetchData(`/api/revenue/${date}`);
            if (!data || !Array.isArray(data)) return;
            
            document.getElementById('chartDate').textContent = date;
            
            // Sort by revenue
            data.sort((a, b) => (b.Paid || 0) - (a.Paid || 0));
            
            // Update chart
            branchChart.data.labels = data.map(d => (d.BranchName || '').replace('Taza Skin Clinic ', 'Taza ').replace('Timona ', 'Tim '));
            branchChart.data.datasets[0].data = data.map(d => d.Paid || 0);
            branchChart.update();
            
            // Update table
            const tbody = document.getElementById('branchTableBody');
            const total = data.reduce((sum, d) => sum + (d.Paid || 0), 0);
            
            tbody.innerHTML = data.map(d => {
                const paid = d.Paid || 0;
                const paidNew = d.PaidNew || 0;
                const numCust = d.PaidNumCust || 0;
                const app = d.App || 0;
                const percent = total > 0 ? ((paid / total) * 100).toFixed(1) : 0;
                
                return `
                    <tr class="table-row border-b">
                        <td class="px-6 py-4 font-medium text-gray-800">${d.BranchName || '-'}</td>
                        <td class="px-6 py-4 text-right font-semibold text-indigo-600">${formatCurrency(paid)}</td>
                        <td class="px-6 py-4 text-right text-green-600">${formatCurrency(paidNew)}</td>
                        <td class="px-6 py-4 text-right">${numCust}</td>
                        <td class="px-6 py-4 text-right">${app}</td>
                        <td class="px-6 py-4 text-center">
                            <div class="flex items-center justify-center">
                                <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-indigo-600 h-2 rounded-full" style="width: ${percent}%"></div>
                                </div>
                                <span class="text-sm text-gray-500">${percent}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update total row
            tbody.innerHTML += `
                <tr class="bg-indigo-50 font-bold">
                    <td class="px-6 py-4 text-gray-800">TỔNG CỘNG</td>
                    <td class="px-6 py-4 text-right text-indigo-700">${formatCurrency(total)}</td>
                    <td class="px-6 py-4 text-right text-green-700">${formatCurrency(data.reduce((s, d) => s + (d.PaidNew || 0), 0))}</td>
                    <td class="px-6 py-4 text-right">${data.reduce((s, d) => s + (d.PaidNumCust || 0), 0)}</td>
                    <td class="px-6 py-4 text-right">${data.reduce((s, d) => s + (d.App || 0), 0)}</td>
                    <td class="px-6 py-4 text-center text-indigo-700">100%</td>
                </tr>
            `;
        }
        
        // Refresh data
        async function refreshData() {
            document.getElementById('todayRevenue').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            await loadSummary();
            await loadRevenueTrend();
        }
        
        // Run sync
        async function runSync() {
            alert('Đang sync dữ liệu... Vui lòng chờ!');
            // In real implementation, this would call a sync endpoint
        }
        
        // Date change
        document.getElementById('dateSelect').addEventListener('change', function() {
            if (this.value) {
                loadRevenueByDate(this.value);
            }
        });
        
        // Init
        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('vi-VN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('lastSyncTime').textContent = new Date().toLocaleTimeString('vi-VN');
            
            initCharts();
            await refreshData();
        });
    </script>
</body>
</html>
